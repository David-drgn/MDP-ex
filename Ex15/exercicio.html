<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposto</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            margin: 0px;
        }

        .register {
            width: 50vw;
            padding: 30px;
            display: flex;
            gap: 10px;
            flex-direction: column;
            border: 1px solid;
            border-radius: 10px;
        }

        .register>div {
            display: flex;
            justify-content: space-between;
            align-items: start;
            width: 100%;
            gap: 10px;
        }

        .register>div>span {
            font-size: 20px;
        }

        input,
        textarea {
            width: 400px;
        }

        textarea {
            height: 100px;
            resize: none;
        }

        .viewer {
            display: flex;
            width: 100%;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .registerUser {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
        }
    </style>
</head>

<body>
    <div class="registerUser">
        <button onclick="registerUser()">Cadastrar user</button>
        <button onclick="login()">Login user</button>
        <button id="view">Ver dados</button>
    </div>
    <form class="register">
        <div>
            <span>Código de município</span>
            <input type="number">
        </div>
        <div>
            <span>Data de vigência</span>
            <input type="date">
        </div>
        <div>
            <span>Código de serviço</span>
            <input type="number">
        </div>
        <div>
            <span>Descrição da aliquota</span>
            <input type="text" maxlength="30">
        </div>
        <div>
            <span>Percentual Alíquota (%)</span>
            <input type="number" max="100" min="0">
        </div>
        <div>
            <span>Data e hora de manutenção</span>
            <input type="datetime-local">
        </div>
        <div>
            <span>Usuário de manutenção</span>
            <input type="text" maxlength="10" disabled>
        </div>
        <button type="button" id="register">Criar</button>
    </form>
    <section class="viewer" style="display: none;">
        <!-- <form class="register">
            <div>
                <span>Código de município</span>
                <input type="number">
            </div>
            <div>
                <span>Data de vigência</span>
                <input type="date">
            </div>
            <div>
                <span>Código de serviço</span>
                <input type="number">
            </div>
            <div>
                <span>Descrição da aliquota</span>
                <input type="text" maxlength="30">
            </div>
            <div>
                <span>Percentual Alíquota (%)</span>
                <input type="number" max="100" min="0">
            </div>
            <div>
                <span>Data e hora de manutenção</span>
                <input type="datetime-local">
            </div>
            <div>
                <span>Usuário de manutenção</span>
                <input type="text" maxlength="10" disabled>
            </div>
            <button type="button">Editar</button>
            <button type="button">Deletar</button>
        </form> -->
    </section>
</body>
<script>
    const transactions = []
    const inputsData = document.getElementsByTagName('input');
    let users = []

    const registerUser = async () => {
        let username = window.prompt('Digite o seu nome de usuário, para o cadastro')
        let userpass = window.prompt('Digite a senha de usuário, para o cadastro')

        if (username.length > 10) {
            alert("O CAMPO DE USUÁRIO NÃO PODE TER MAIS DE 10 CARECTERES")
            return false
        }

        if (username == "" || userpass == "") {
            alert("UM CAMPO ESTÁ VAZIO, TENTE NOVAMENTE")
            return false
        }

        let getUser = users.find(e => e.username === username)
        if (getUser != undefined) {
            alert("Esse usuário já existe")
            return false
        }

        let userLog = users.find(e => e.inuse)
        if (userLog != undefined) userLog.inuse = false

        users.push({
            inuse: true,
            username,
            userpass
        })

        inputsData[inputsData.length - 1].value = username
        return true
    }

    const login = () => {
        let username = window.prompt('Digite o seu nome de usuário, para o cadastro')
        let userpass = window.prompt('Digite a senha de usuário, para o cadastro')

        if (username.length > 10) {
            alert("O CAMPO DE USUÁRIO NÃO PODE TER MAIS DE 10 CARECTERES")
            return false
        }

        if (username == "" || userpass == "") {
            alert("UM CAMPO ESTÁ VAZIO, TENTE NOVAMENTE")
            return false
        }

        let getUser = users.find(e => e.username === username && e.userpass === userpass)
        if (getUser == undefined) {
            alert("Esse usuário não existe")
            return false
        }

        let userLog = users.find(e => e.inuse)
        if (userLog != undefined) userLog.inuse = false

        inputsData[inputsData.length - 1].value = username
        getUser.inuse = true
    }

    window.addEventListener('load', async () => {
        let recive = await registerUser()
        if (!recive) location.reload()
    })

    class Transaction {
        pk;
        descAliquota;
        percAliquota;
        dataHoraManutencao;
        usuarioManutencao;

        constructor(inputs) {
            this.pk = {
                codMunicipio: inputs[0].value,
                dataVigencia: inputs[1].value,
                codServico: inputs[2].value
            }
            this.descAliquota = inputs[3].value;
            this.percAliquota = parseFloat(inputs[4].value).toFixed(2);
            this.dataHoraManutencao = inputs[5].value;
            this.usuarioManutencao = inputs[6].value
        }

        getEvery() {
            return [
                this.pk.codMunicipio,
                this.pk.dataVigencia,
                this.pk.codServico,
                this.descAliquota,
                this.percAliquota,
                this.dataHoraManutencao,
                this.usuarioManutencao]
        }

        update(inputs) {
            this.pk = {
                codMunicipio: inputs[0].value,
                dataVigencia: inputs[1].value,
                codServico: inputs[2].value
            }
            this.descAliquota = inputs[3].value;
            this.percAliquota = parseFloat(inputs[4].value).toFixed(2);
            this.dataHoraManutencao = inputs[5].value;
            this.usuarioManutencao = inputs[6].value
        }
    }

    document.getElementById('register').addEventListener('click', () => {
        try {
            for (let i = 0; i < inputsData.length; i++) if (inputsData[i].value == "") throw "Dados incompletos"

            const newPk = {
                codMunicipio: inputsData[0].value,
                dataVigencia: inputsData[1].value,
                codServico: inputsData[2].value
            }

            for (let i = 0; i < transactions.length; i++) {
                const element = transactions[i];
                if (element.pk.codMunicipio == newPk.codMunicipio &&
                    element.pk.dataVigencia == newPk.dataVigencia &&
                    element.pk.codServico == newPk.codServico) {
                    alert("Essa transação já existe")
                    return
                }
            }

            transactions.push(new Transaction(inputsData))
            for (let i = 0; i < inputsData.length - 1; i++) inputsData[i].value = ""

        } catch (e) {
            alert(`${e}. Tente novamente`)
        }
    })

    document.getElementById('view').addEventListener('click', () => {
        if (document.getElementsByClassName('register')[0].style.display != 'none') {
            document.getElementsByClassName('register')[0].style.display = 'none'
            document.getElementsByClassName('viewer')[0].style.display = 'flex'

            const container = document.querySelector('.viewer');

            if (container) {
                // Limpa todos os elementos filhos da seção
                container.innerHTML = '';
            } else {
                console.error('Seção com a classe "viewer" não encontrada.');
            }

            for (let i = 0; i < transactions.length; i++) {
                const element = transactions[i];
                view(element)
            }
        }
        else {
            document.getElementsByClassName('register')[0].style.display = 'flex'
            document.getElementsByClassName('viewer')[0].style.display = 'none'
        }
    })

    const view = (item) => {


        // Array of field names
        const fieldNames = ["Código de município", "Data de vigência", "Código de serviço", "Descrição da aliquota", "Percentual Alíquota (%)", "Data e hora de manutenção", "Usuário de manutenção"];

        // Get the form element
        const form = document.createElement('form');
        form.classList = "register"

        let inputs = []

        // Create input fields dynamically
        fieldNames.forEach((fieldName, index) => {
            const div = document.createElement("div");
            const span = document.createElement("span");
            span.textContent = fieldName;
            div.appendChild(span);
            const input = document.createElement("input");
            switch (index) {
                case 0:
                    input.disabled = true
                    break;
                case 1:
                    input.disabled = true
                    break;
                case 2:
                    input.disabled = true
                    break;
                case 3:
                    input.type = 'text'
                    break;
                case 4:
                    input.type = 'number'
                    break;
                case 5:
                    input.type = 'datetime-local'
                    break;
                case 6:
                    input.disabled = true
                    break;
                default:
                    break;
            }
            input.value = item.getEvery()[index]
            div.appendChild(input);
            form.appendChild(div);
            inputs.push(input)
        });

        // Create Edit and Delete buttons
        const editButton = document.createElement("button");
        editButton.textContent = "Editar";
        editButton.type = "button";
        editButton.addEventListener('click', () => {
            let transacao = transactions.find(e => e === item)
            transacao.update(inputs)
        });
        form.appendChild(editButton);

        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Deletar";
        deleteButton.type = "button";
        deleteButton.addEventListener('click', () => {
            form.remove()
            transactions = transactions.filter(e => e !== item)

        });

        form.appendChild(deleteButton);

        document.getElementsByClassName('viewer')[0].appendChild(form)
    }
</script>

</html>